<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin – Enable Notifications</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="manifest" href="/manifest.json">
  <style>body{font-family:sans-serif;padding:2rem;background:#f8f9fa}h1{margin-bottom:2rem}button{padding:1rem 2rem;font-size:1.2rem;background:#0070f3;color:white;border:none;border-radius:8px;cursor:pointer}</style>
</head>
<body>
  <h1>Calyvent Admin – Enable Push Notifications</h1>
  <button id="enable">Enable Push Notifications Now</button>
  <p id="status" style="margin-top:1rem;font-weight:bold"></p>

  <script type="module">
    const supabaseUrl = 'https://offrohhavllnldqrofck.supabase.co'; // ← CHANGE
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mZnJvaGhhdmxsbmxkcXJvZmNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NjIzNzcsImV4cCI6MjA3OTIzODM3N30.fyUPt8W1Di9dFXKBqDAO0VOaMEmng2EQOPFyLE2RzIc';               // ← CHANGE

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const vapidPublicKey = 'BKMrtHn1zpg8k7pU-aXhmgMbtu0FKMWfKQQv1osfT7FNKwWAbwvlwYvONy0YJ-ip8G4RsIQWZvXwlU_fuA-6Luw';

    document.getElementById('enable').onclick = async () => {
      const status = document.getElementById('status');
      status.textContent = 'Working...';

      try {
        const reg = await navigator.serviceWorker.register('/sw.js');
        await navigator.serviceWorker.ready;

        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: vapidPublicKey
        });

        await supabase.from('push_subscriptions').upsert({ subscription: sub.toJSON() });

        status.textContent = '✅ SUCCESS! You will now get notifications even when browser is closed';
        document.getElementById('enable').disabled = true;
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        console.error(err);
      }
    };
  </script>
</body>
</html>
